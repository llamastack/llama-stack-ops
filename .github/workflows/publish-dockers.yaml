name: Publish Docker images

on:
  workflow_dispatch:  # Keep manual trigger
    inputs:
      version:
        description: 'Version number (e.g. 0.1.1rc2, 0.1.1.dev20250201)'
        required: true
        type: string
      templates:
        description: 'Optional comma-separated templates to publish'
        required: false
        type: string
      dockerhub_organization:
        description: 'DockerHub organization'
        required: false
        type: string
        default: llamastack

jobs:
  publish-docker-images-amd64:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ./actions/publish-dockers
      with:
        version: ${{ inputs.version }}
        templates: ${{ inputs.templates }}
        dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
        dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
        dockerhub_organization: ${{ inputs.dockerhub_organization }}
        arch: amd64

  publish-docker-images-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
    - uses: actions/checkout@v4
    - uses: ./actions/publish-dockers
      with:
        version: ${{ inputs.version }}
        templates: ${{ inputs.templates }}
        dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
        dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
        dockerhub_organization: ${{ inputs.dockerhub_organization }}
        continue_on_error: true
        arch: arm64

  publish-docker-manifest-lists:
    needs:
    - publish-docker-images-amd64
    - publish-docker-images-arm64
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: ./actions/publish-docker-manifest-lists
      with:
        version: ${{ inputs.version }}
        templates: ${{ inputs.templates }}
        dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
        dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
        dockerhub_organization: ${{ inputs.dockerhub_organization }}
