name: Publish Docker images

on:
  workflow_dispatch:  # Keep manual trigger
    inputs:
      version:
        description: 'Version number (e.g. 0.1.1rc2, 0.1.1.dev20250201)'
        required: true
        type: string
      distros:
        description: 'Optional comma-separated distributions to publish'
        required: false
        type: string

jobs:
  publish-cpu-distros:
    # Skip this job if custom distros are specified (to avoid building the same thing twice)
    if: ${{ inputs.distros == '' }}
    runs-on: ubuntu-latest
    steps:
    - name: Free Disk Space
      run: |
        echo "Disk space before cleanup:"
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        docker system prune -af --volumes
        echo "Disk space after cleanup:"
        df -h

    - uses: actions/checkout@v4

    - uses: ./actions/publish-dockers
      with:
        version: ${{ inputs.version }}
        distros: 'starter,postgres-demo,dell'
        dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
        dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}

  publish-gpu-distros:
    # Skip this job if custom distros are specified (to avoid building the same thing twice)
    if: ${{ inputs.distros == '' }}
    runs-on: ubuntu-latest
    steps:
    - name: Free Disk Space
      run: |
        echo "Disk space before cleanup:"
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        docker system prune -af --volumes
        echo "Disk space after cleanup:"
        df -h

    - uses: actions/checkout@v4

    - uses: ./actions/publish-dockers
      with:
        version: ${{ inputs.version }}
        distros: 'meta-reference-gpu,starter-gpu'
        dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
        dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}

  publish-custom-distros:
    # Only run if custom distros are specified
    if: ${{ inputs.distros != '' }}
    runs-on: ubuntu-latest
    steps:
    - name: Free Disk Space
      run: |
        echo "Disk space before cleanup:"
        df -h
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        docker system prune -af --volumes
        echo "Disk space after cleanup:"
        df -h

    - uses: actions/checkout@v4

    - uses: ./actions/publish-dockers
      with:
        version: ${{ inputs.version }}
        distros: ${{ inputs.distros }}
        dockerhub_username: ${{ secrets.DOCKERHUB_USERNAME }}
        dockerhub_token: ${{ secrets.DOCKERHUB_TOKEN }}
